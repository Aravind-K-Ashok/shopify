<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel | Shopify</title>
  <link rel="stylesheet" href="css/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #070707;
      --panel: #0f0f10;
      --muted: #25fff4;
      --accent: #00bfa6;
      --sub: #9be7ff;
      --error: #ff4d4d;
      --glow: rgba(0,255,255,0.18);
      --radius: 14px;
    }
    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      background: var(--bg);
      color: white;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header.navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 40px;
      background: rgba(15,15,16,0.9);
      box-shadow: 0 2px 20px rgba(0,0,0,0.4);
      position: sticky;
      top: 0;
      z-index: 999;
    }
    .logo { font-size: 1.6rem; font-weight: 600; color: white; }
    .logo span { color: var(--accent); }
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px;
    }
    .card {
      background: var(--panel);
      border-radius: var(--radius);
      padding: 28px;
      max-width: 700px;
      width: 100%;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.6), 0 0 30px rgba(0,0,0,0.4) inset;
      border: 1px solid rgba(255,255,255,0.05);
      backdrop-filter: blur(6px);
    }
    h2 { color: var(--accent); margin-bottom: 10px; }
    input, select {
      width: 100%;
      margin: 8px 0;
      padding: 10px;
      border-radius: 10px;
      border: none;
      background: rgba(255,255,255,0.05);
      color: white;
    }
    button {
      background: linear-gradient(90deg, var(--accent), var(--sub));
      color: black;
      border: none;
      padding: 10px 14px;
      margin-top: 10px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      width: 100%;
    }
    button:hover {
      box-shadow: 0 0 20px var(--accent);
      transform: translateY(-3px);
    }
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--panel);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      box-shadow: 0 0 20px var(--accent);
      animation: fade 2s ease;
    }
    @keyframes fade {
      0% { opacity: 0; transform: translate(-50%, 20px); }
      10% { opacity: 1; transform: translate(-50%, 0); }
      90% { opacity: 1; }
      100% { opacity: 0; transform: translate(-50%, 20px); }
    }
  </style>
</head>

<body>
  <!-- shared NAVBAR -->
  <div id="site-header"></div>
  <script src="js/header.js"></script>

  <main>
    <div class="card">
      <h2>üìÅ Manage Categories</h2>
      <input id="categoryName" placeholder="Enter category name">
      <button onclick="addCategory()">‚ûï Add Category</button>
      <button onclick="loadCategories()">üîÑ Refresh Categories</button>
      <ul id="categoryList"></ul>
    </div>

    <div class="card">
      <h2>üìÇ Manage Subcategories</h2>
      <select id="parentCategory" onchange="loadSubcategories()"></select>
      <input id="subcatName" placeholder="Enter subcategory name">
      <button onclick="addSubcategory()">‚ûï Add Subcategory</button>
      <ul id="subcatList"></ul>
    </div>

    <div class="card">
      <h2>üõí Add Product</h2>
      <input id="productDesc" placeholder="Product Description">
      <input id="productStock" type="number" placeholder="Stock Quantity">
      <input id="productRating" type="number" step="0.1" min="0" max="5" placeholder="Rating (optional)">
      <input id="productImage" placeholder="Image URL (Supabase)">
      <select id="productSubcat"></select>
      <button onclick="addProduct()">üöÄ Add Product</button>
    </div>
  </main>

  <script>
    const API_BASE = "https://shopify-backend-m9ce.onrender.com";
    const adminID = localStorage.getItem("customerID");

    if (!adminID) {
      alert("‚ö†Ô∏è Please login first.");
      window.location.href = "login.html";
    } else if (adminID !== "100002") {
      alert("üö´ Access denied: Admins only!");
      window.location.href = "index.html";
    }

    function showToast(msg) {
      const t = document.createElement("div");
      t.className = "toast";
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 2500);
    }

    // ‚úÖ CATEGORY MANAGEMENT
    async function addCategory() {
      const name = document.getElementById("categoryName").value.trim();
      if (!name) return showToast("‚ö†Ô∏è Enter a category name.");

      try {
        const res = await fetch(`${API_BASE}/categories/add?customerid=${adminID}&name=${encodeURIComponent(name)}`, {
          method: "POST"
        });
        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          showToast(`Error ${res.status}: ${txt || res.statusText}`);
          return;
        }
        const data = await res.json().catch(() => ({}));
        showToast(data.message?.message || data.detail || data.message || "Done");
        loadCategories();
      } catch (err) {
        console.error("addCategory error:", err);
        showToast("Network error: Could not reach API.");
      }
    }

    async function loadCategories() {
      try {
        const res = await fetch(`${API_BASE}/categories/`);
        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          showToast(`Error ${res.status}: ${txt || res.statusText}`);
          return;
        }
        const data = await res.json().catch(() => ({}));
        const cats = Array.isArray(data) ? data : (data.categories || []);
        const list = document.getElementById("categoryList");
        const select = document.getElementById("parentCategory");
        list.innerHTML = "";
        select.innerHTML = "";

        cats.forEach(cat => {
          const li = document.createElement("li");
          li.textContent = `${cat.categoryid}: ${cat.name}`;
          list.appendChild(li);

          const opt = document.createElement("option");
          opt.value = cat.categoryid;
          opt.textContent = cat.name;
          select.appendChild(opt);
        });

        if (cats.length > 0) loadSubcategories(); // auto-load first category's subcategories
      } catch (err) {
        console.error("loadCategories error:", err);
        showToast("Network error: Could not load categories.");
      }
    }

    // ‚úÖ SUBCATEGORY MANAGEMENT
    async function addSubcategory() {
      const name = document.getElementById("subcatName").value.trim();
      const catid = document.getElementById("parentCategory").value;
      if (!name || !catid) return showToast("‚ö†Ô∏è Fill both fields.");

      try {
        const res = await fetch(`${API_BASE}/categories/${catid}/subcategories/add?name=${encodeURIComponent(name)}`, {
          method: "POST"
        });
        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          showToast(`Error ${res.status}: ${txt || res.statusText}`);
          return;
        }
        const data = await res.json().catch(() => ({}));
        showToast(data.message || data.detail || "Done");
        loadSubcategories();
      } catch (err) {
        console.error("addSubcategory error:", err);
        showToast("Network error: Could not reach API.");
      }
    }

    async function loadSubcategories() {
      const catid = document.getElementById("parentCategory").value;
      if (!catid) return;
      try {
        const res = await fetch(`${API_BASE}/categories/${catid}/subcategories`);
        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          showToast(`Error ${res.status}: ${txt || res.statusText}`);
          return;
        }
        const data = await res.json().catch(() => ({}));
        const subs = Array.isArray(data) ? data : (data.subcategories || []);

        const list = document.getElementById("subcatList");
        const subcatSelect = document.getElementById("productSubcat");
        list.innerHTML = "";
        subcatSelect.innerHTML = "";

        if (Array.isArray(subs) && subs.length) {
          subs.forEach(sub => {
            const li = document.createElement("li");
            li.textContent = `${sub.subcategoryid}: ${sub.name}`;
            list.appendChild(li);

            const opt = document.createElement("option");
            opt.value = sub.subcategoryid;
            opt.textContent = sub.name;
            subcatSelect.appendChild(opt);
          });
        } else {
          list.innerHTML = `<li>No subcategories found.</li>`;
        }
      } catch (err) {
        console.error("loadSubcategories error:", err);
        showToast("Network error: Could not load subcategories.");
      }
    }

    // ‚úÖ PRODUCT ADDITION
    async function addProduct() {
      const desc = document.getElementById("productDesc").value.trim();
      const stock = document.getElementById("productStock").value;
      const rating = document.getElementById("productRating").value || 0.0;
      const image = document.getElementById("productImage").value.trim();
      const subcat = document.getElementById("productSubcat").value;

      if (!desc || !stock || !image || !subcat)
        return showToast("‚ö†Ô∏è All fields except rating required.");
      try {
        const url = `${API_BASE}/products/add?sellerid=${adminID}&description=${encodeURIComponent(desc)}&subcategoryid=${encodeURIComponent(subcat)}&stock=${encodeURIComponent(stock)}&rating=${encodeURIComponent(rating)}&image_url=${encodeURIComponent(image)}`;
        const res = await fetch(url, { method: "POST" });
        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          showToast(`Error ${res.status}: ${txt || res.statusText}`);
          return;
        }
        const data = await res.json().catch(() => ({}));
        showToast(data.message?.message || data.detail || data.message || "Done");
      } catch (err) {
        console.error("addProduct error:", err);
        showToast("Network error: Could not reach API.");
      }
    }

    function logout() {
      localStorage.removeItem("customerID");
      showToast("Logged out successfully");
      setTimeout(() => (window.location.href = "login.html"), 800);
    }

    // Load on start
    loadCategories();
  </script>
</body>
</html>
